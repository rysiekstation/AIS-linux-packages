#!@TERMUX_PREFIX@/bin/bash

if [ "$1" == "--help" ] || [ "$1" == "-help" ]; then
    echo "Script for redirecting subscribed repositories to mirrors."
    echo "You can choose between mirrors listed at"
    echo "https://github.com/termux/termux-packages/wiki/Mirrors"
    exit 0
fi

select_repository() {
    if [ "$1" == "Official repositories" ]; then
        echo "[*] Official repositories selected"
        MAIN="http://powiedz.co/apt/dists/dom/stable/"

    elif [ "$1" == "BETA by AI-Speaker" ]; then
        echo "[*] A1batross's mirrors selected"
        MAIN="https://powiedz.co/apt/dists/dom-dev/beta/"

    else
        echo "[!] Error: unknown repository: '$1'. Exiting"
        exit 1
    fi

    replace_repository sources.list $MAIN "stable main" "$2" "Main repository"
}

replace_repository() {
    if [[ "$4" == *"$5"* ]]; then
        SOURCE_FILE="$1"
        NEW_URL="$2"
        COMPONENT_SUITE="$3"

        TMPFILE="$(mktemp $TMPDIR/$(basename ${SOURCE_FILE}).XXXXXX)"
        if [ "$1" == "sources.list" ]; then
            echo "# The main termux repository:" >> "$TMPFILE"
        fi
        echo "deb ${NEW_URL} ${COMPONENT_SUITE}" >> "$TMPFILE"
        echo "    Changing ${5,,}" #${,,} converts to lower case
        mv "$TMPFILE" "$PREFIX/etc/apt/${SOURCE_FILE}"
    fi
}

TEMPFILE="$(mktemp $PREFIX/tmp/mirror.XXXXXX)"

REPOSITORIES=()
REPOSITORIES+=("Main repository" "termux-packages" "on")

dialog \
    --title "termux-change-repo" --clear \
    --checklist "Which repositories do you want to edit? Select with space." 0 0 0 \
    "${REPOSITORIES[@]}" --and-widget \
    --title "termux-change-repo" --clear \
    --radiolist "Which mirror do you want to use?" 0 0 0 \
    "Official repositories" "Hosted by AI-Speaker" on \
    "BETA by AI-Speaker" "Hosted by AI-Speaker" off \
    2> "$TEMPFILE"

retval=$?
clear

case $retval in
    0)
        IFS=$'\t' read REPOSITORIES MIRROR <<< "$(more $TEMPFILE)"
        select_repository "$MIRROR" "$REPOSITORIES"
        ;;
    1)
        # Cancel pressed
        exit
        ;;
    255)
        # Esc pressed
        exit
        ;;
esac

rm "$TEMPFILE"

echo "[*] Running apt update"
apt update
